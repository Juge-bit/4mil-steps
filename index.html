<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4 000 000 askelta – 2026</title>
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#121a33;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --line:rgba(255,255,255,.10);
      --good:#7CFFB2;
      --warn:#FFD36E;
      --accent:#7aa2ff;
      --accent2:#b18cff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(122,162,255,.35), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(177,140,255,.25), transparent 55%),
        radial-gradient(900px 600px at 60% 95%, rgba(124,255,178,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 60px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      margin:10px 0 18px;
    }
    .title h1{margin:0;letter-spacing:.2px}
.title h1.mainTitle{font-size:28px; letter-spacing:.3px}

    .percentBlock{
  text-align: center;
  margin-top: 6px;
}

    .title p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius:999px; box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      white-space:nowrap;
      font-size:13px;color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 18px rgba(255,211,110,.45)}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }
    @media (max-width:860px){ .grid{grid-template-columns:1fr} header{flex-direction:column} }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;inset:-2px;
      background: radial-gradient(600px 250px at 30% 0%, rgba(122,162,255,.18), transparent 65%);
      pointer-events:none;
    }
    .card > *{position:relative}
    .kpiRow{display:flex;gap:12px;flex-wrap:wrap;align-items:baseline}
    .kpi{
      flex:1 1 220px;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:30px;margin-top:6px;letter-spacing:.3px}
    .kpi .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .bigNumber{
      font-size:44px;letter-spacing:.4px;margin:10px 0 0;
    }
    .muted{color:var(--muted)}
    .progressOuter{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      overflow:hidden;
      height:16px;
    }
    .progressInner{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--good));
      filter:saturate(1.1);
      transition: width 900ms cubic-bezier(.2,.9,.2,1);
      box-shadow: 0 0 20px rgba(122,162,255,.25);
    }
    .progressMeta{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-top:10px;font-size:12px;color:var(--muted);
    }
    .milestones{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .badge{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
    }
    .badge.on{color:rgba(255,255,255,.9); border-color:rgba(124,255,178,.35); background:rgba(124,255,178,.10)}
    .spark{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.16)}
    .badge.on .spark{background:var(--good);box-shadow:0 0 18px rgba(124,255,178,.35)}
    .chart{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.16);
      padding:12px;
    }
    .bars{
      display:flex;align-items:flex-end;gap:6px;height:140px;
      padding:6px 2px 2px;
    }
    .bar{
      flex:1;
      border-radius:10px 10px 6px 6px;
      background:linear-gradient(180deg, rgba(122,162,255,.85), rgba(177,140,255,.55));
      border:1px solid rgba(255,255,255,.10);
      position:relative;
      min-width:10px;
      transition: transform .15s ease;
    }
    .bar:hover{transform: translateY(-2px)}
    .bar::after{
      content: attr(data-steps);
      position:absolute;left:50%;transform:translateX(-50%);
      bottom: calc(100% + 6px);
      font-size:11px;color:var(--muted);
      opacity:0;transition:opacity .15s ease;
      white-space:nowrap;
    }
    .bar:hover::after{opacity:1}
    .barLabelRow{display:flex;gap:6px;margin-top:6px;font-size:10px;color:var(--muted)}
    .barLabelRow span{flex:1;text-align:center;opacity:.7}
    .sideList{display:grid;gap:10px}
    .row{
      display:flex;justify-content:space-between;gap:12px;
      padding:12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
    }
    .row b{font-weight:650}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}
    footer{margin-top:16px;color:rgba(255,255,255,.45);font-size:11px}
    canvas#confetti{
      position:fixed;inset:0;pointer-events:none;
    }
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      color:rgba(255,255,255,.9);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .btn:active{transform: translateY(1px)}
    .errorBox{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,211,110,.35);
      background:rgba(255,211,110,.08);
      color:rgba(255,255,255,.9);
      display:none;
    }
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

.kpi{
  text-align: center;
}

.mainTitle{
  font-size: 28px;
  letter-spacing: .3px;
}

  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <header>
      <div class="title">
        <h1 class="mainTitle">Neljä miljoonaa askelta vuonna 2026</h1>
      </div>


      <div class="pill" id="statusPill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Ladataan…</span>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="kpiRow">
          <div class="kpi">
            <div class="label">Askeleet yhteensä</div>
            <div class="value" id="totalSteps">—</div>
            <div class="sub"><span class="muted">Tavoite:</span> 4 000 000</div>
          </div>
          <div class="kpi">
            <div class="label">Eilen</div>
            <div class="value" id="todaySteps">—</div>
            <div class="sub" id="todayDate">—</div>
          </div>
        </div>

<div class="percentBlock">
  <div class="bigNumber" id="percentText">—%</div>
  <div class="muted" id="paceText">—</div>
</div>

        <div class="progressOuter" aria-label="Edistymispalkki">
          <div class="progressInner" id="progressInner"></div>
        </div>

        <div class="progressMeta">
          <div><span class="muted">Jäljellä:</span> <span id="remainingSteps">—</span></div>
          <div><span class="muted">Päivätahti:</span> <span id="dailyPace">—</span></div>
        </div>

        <div class="milestones" id="milestones"></div>

        <div class="chart">
          <div class="muted" style="font-size:12px;">Viimeiset 14 päivää (hover: askelmäärä)</div>
          <div class="bars" id="bars"></div>
          <div class="barLabelRow" id="barLabels"></div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" id="demoMilestoneBtn">Simuloi milestone</button>
          <button class="btn" id="reloadBtn">Lataa data uudelleen</button>
        </div>

        <div class="errorBox" id="errorBox"></div>

        </section>

      <aside class="card">
        <div class="sideList">
          <div class="row">
            <div>
              <div class="muted" style="font-size:12px;">Tähän asti paras päivä</div>
              <b id="bestDay">—</b>
            </div>
            <div style="text-align:right">
              <div class="muted" style="font-size:12px;">Askeleet</div>
              <b id="bestSteps">—</b>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="muted" style="font-size:12px;">Keskiarvo (14 pv)</div>
              <b id="avg14">—</b>
            </div>
            <div style="text-align:right">
              <div class="muted" style="font-size:12px;">Suuntaus</div>
              <b id="trend">—</b>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="muted" style="font-size:12px;">Seuraava virstanpylväs</div>
              <b id="nextMilestone">—</b>
            </div>
            <div style="text-align:right">
              <div class="muted" style="font-size:12px;">Etäisyys</div>
              <b id="nextMilestoneGap">—</b>
            </div>
          </div>

          <div class="hint" id="lastUpdatedBox">
            Viimeisin päivitys: <span id="lastUpdatedAt">—</span>
          </div>

          
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const GOAL = 4_000_000;
    const DASHBOARD_ENDPOINT =
      "https://script.google.com/macros/s/AKfycbwYzAuWf133DhP2QQDXH8DkYGiC-dMNicveElKQiXy7Cmj0FGJ-yBVqot3OZmidBJdt/exec?mode=dashboard&year=2026";

    // Milestones
    const MILESTONES = [250_000, 500_000, 1_000_000, 2_000_000, 3_000_000, 4_000_000];

    // ====== HELPERS ======
    const fmt = (n) => new Intl.NumberFormat("fi-FI").format(Math.round(n));
    const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

    function setStatus(mode, titleText) {
      const dot = document.getElementById("statusDot");
      const text = document.getElementById("statusText");
      const pill = document.getElementById("statusPill");

      if (mode === "live") {
        dot.style.background = "var(--good)";
        dot.style.boxShadow = "0 0 18px rgba(124,255,178,.35)";
        text.textContent = "Live-data";
      } else if (mode === "error") {
        dot.style.background = "var(--warn)";
        dot.style.boxShadow = "0 0 18px rgba(255,211,110,.45)";
        text.textContent = "Virhe";
      } else {
        dot.style.background = "var(--warn)";
        dot.style.boxShadow = "0 0 18px rgba(255,211,110,.45)";
        text.textContent = "Ladataan…";
      }

      pill.title = titleText || "";
    }

    function renderMilestones(total) {
      const wrap = document.getElementById("milestones");
      wrap.innerHTML = "";
      for (const m of MILESTONES) {
        const on = total >= m;
        const el = document.createElement("div");
        el.className = "badge" + (on ? " on" : "");
        el.innerHTML = `<span class="spark"></span> ${fmt(m)}`;
        wrap.appendChild(el);
      }
    }

    function computeTrend(days) {
      const last7 = days.slice(-7).map(d => d.steps);
      const prev7 = days.slice(0, 7).map(d => d.steps);
      const avg = arr => arr.reduce((a,b)=>a+b,0)/Math.max(1, arr.length);
      const a = avg(last7), b = avg(prev7);
      const diff = a - b;
      const pct = (diff / Math.max(1, b)) * 100;
      return { diff, pct };
    }

    function renderBars(days) {
      const bars = document.getElementById("bars");
      const labels = document.getElementById("barLabels");
      bars.innerHTML = "";
      labels.innerHTML = "";

      const maxSteps = Math.max(...days.map(d => d.steps), 1);
      for (const d of days) {
        const h = clamp((d.steps / maxSteps) * 100, 4, 100);
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = h + "%";
        bar.setAttribute("data-steps", fmt(d.steps));
        bars.appendChild(bar);

        const s = document.createElement("span");
        s.textContent = d.date.slice(8,10);
        labels.appendChild(s);
      }
    }

    function pickBestDay(days) {
      let best = days[0] || { date: "", steps: 0 };
      for (const d of days) if (d.steps > best.steps) best = d;
      return best;
    }

    function nextMilestone(total) {
      for (const m of MILESTONES) {
        if (total < m) return m;
      }
      return GOAL;
    }

    function showError(msg) {
      const box = document.getElementById("errorBox");
      box.style.display = "block";
      box.textContent = msg;
    }

    function clearError() {
      const box = document.getElementById("errorBox");
      box.style.display = "none";
      box.textContent = "";
    }

    // ====== CONFETTI ======
    const confetti = (() => {
      const canvas = document.getElementById("confetti");
      const ctx = canvas.getContext("2d");
      let w=0,h=0,parts=[],running=false,until=0;

      function resize(){
        w = canvas.width = window.innerWidth * devicePixelRatio;
        h = canvas.height = window.innerHeight * devicePixelRatio;
      }
      window.addEventListener("resize", resize);

      function burst(){
        resize();
        const now = performance.now();
        until = now + 1600;
        parts = [];
        for(let i=0;i<160;i++){
          parts.push({
            x: (Math.random()*w),
            y: -Math.random()*h*0.2,
            vx: (Math.random()-0.5)*2.2*devicePixelRatio,
            vy: (Math.random()*3.2+1.2)*devicePixelRatio,
            r: (Math.random()*6+2)*devicePixelRatio,
            rot: Math.random()*Math.PI,
            vr: (Math.random()-0.5)*0.18
          });
        }
        if(!running){
          running = true;
          requestAnimationFrame(tick);
        }
      }

      function tick(t){
        ctx.clearRect(0,0,w,h);
        for(const p of parts){
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.vy += 0.02*devicePixelRatio;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.globalAlpha = 0.9;
          ctx.fillStyle = "rgba(255,255,255,.9)";
          ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*0.6);
          ctx.restore();
        }
        parts = parts.filter(p => p.y < h + 20*devicePixelRatio);
        if(t < until && parts.length){
          requestAnimationFrame(tick);
        }else{
          running=false;
          ctx.clearRect(0,0,w,h);
        }
      }
      return { burst };
    })();

    // ====== DATA LOADER ======
   async function loadData() {
  const res = await fetch(DASHBOARD_ENDPOINT, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);

  const j = await res.json();
  if (!j || j.ok !== true) throw new Error(j?.error || "Invalid payload");

  // Use "yesterday" as the last completed day.
  // If you ever miss a day, this still keeps the UI aligned to yesterday.
  return {
    totalSteps: j.totalSteps,
    asOf: { date: j.yesterday, steps: j.yesterdaySteps },   // <- KEY CHANGE
    last14Days: j.last14Days,
    lastUpdatedAt: j.lastUpdatedAt
  };
}

    // ====== MAIN RENDER ======
    async function render() {
      clearError();
      setStatus("loading", "Haetaan dataa…");

      
      const data = await loadData();
      setStatus("live", data.lastUpdatedAt ? ("Viimeisin päivitys: " + new Date(data.lastUpdatedAt).toLocaleString("fi-FI")) : "Live-data");

      const total = data.totalSteps;
const asOfSteps = data.asOf.steps;

document.getElementById("todaySteps").textContent = fmt(asOfSteps);

const d = new Date(data.asOf.date + "T12:00:00");
document.getElementById("todayDate").textContent =
  d.toLocaleDateString("fi-FI", { weekday:"long", year:"numeric", month:"long", day:"numeric" });


      const pct = clamp((total / GOAL) * 100, 0, 100);
      document.getElementById("percentText").textContent = pct.toFixed(2).replace(".", ",") + "%";
      document.getElementById("progressInner").style.width = pct + "%";

      const remaining = Math.max(0, GOAL - total);
      document.getElementById("remainingSteps").textContent = fmt(remaining);

      // Pace estimate
      const now = new Date(data.asOf.date + "T12:00:00"); // anchor calculations to "as of yesterday"
      const yearStart = new Date("2026-01-01T00:00:00");
      const dayOfYear = Math.max(1, Math.ceil((now - yearStart)/(24*3600*1000)) + 1);
      const avgSoFar = total / dayOfYear;

      const yearEnd = new Date("2026-12-31T23:59:59");
      const daysLeft = Math.max(1, Math.ceil((yearEnd - now)/(24*3600*1000)));
      const requiredPace = remaining / daysLeft;

      document.getElementById("dailyPace").textContent = `Tarvittava päivätahti: ${fmt(requiredPace)} askelta`;
      document.getElementById("paceText").textContent =
      `Tilanne eilisen jälkeen • Keskiarvo tähän asti: ${fmt(avgSoFar)} askelta/pv • Päiviä jäljellä: ${fmt(daysLeft)}`;


      renderMilestones(total);
      renderBars(data.last14Days);

      // Show last 14 days ending at "asOf" (yesterday)
      const barsDays = data.last14Days.filter(d => d.date <= data.asOf.date);  
      renderBars(barsDays.slice(-14));

      const best = pickBestDay(data.last14Days);
      document.getElementById("bestDay").textContent = best.date
        ? new Date(best.date+"T12:00:00").toLocaleDateString("fi-FI",{ weekday:"short", month:"short", day:"numeric" })
        : "—";
      document.getElementById("bestSteps").textContent = fmt(best.steps || 0);

      const avg14 = data.last14Days.reduce((a,b)=>a+(b.steps||0),0) / Math.max(1, data.last14Days.length);
      document.getElementById("avg14").textContent = fmt(avg14);

      const tr = computeTrend(data.last14Days);
      const arrow = tr.diff >= 0 ? "↗" : "↘";
      document.getElementById("trend").textContent =
        `${arrow} ${fmt(Math.abs(tr.diff))}/pv (${Math.abs(tr.pct).toFixed(1).replace(".", ",")}%)`;

      const nm = nextMilestone(total);
      document.getElementById("nextMilestone").textContent = fmt(nm);
      document.getElementById("nextMilestoneGap").textContent = fmt(Math.max(0, nm-total));

      // Last updated text
      if (data.lastUpdatedAt) {
        const lu = new Date(data.lastUpdatedAt);
        document.getElementById("lastUpdatedAt").textContent = lu.toLocaleString("fi-FI");
      } else {
        document.getElementById("lastUpdatedAt").textContent = "—";
      }

      // Celebrate if near a milestone threshold
      const justHit = MILESTONES.some(m => total >= m && (total - m) < 2000);
      if (justHit) confetti.burst();
    }

    // Buttons
    document.getElementById("demoMilestoneBtn").addEventListener("click", () => confetti.burst());
    document.getElementById("reloadBtn").addEventListener("click", () => {
      render().catch(err => {
        console.error(err);
        setStatus("error", String(err));
        showError("Datan haku epäonnistui: " + String(err));
      });
    });

    // Initial load
    render().catch(err => {
      console.error(err);
      setStatus("error", String(err));
      showError("Datan haku epäonnistui: " + String(err));
    });
  </script>
</body>
</html>



